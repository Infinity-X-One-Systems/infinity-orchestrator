version: '3.8'

# Genesis Autonomous Software Factory — Docker services
# Integrates with infinity-orchestrator Singularity Mesh.
#
# Usage:
#   docker-compose -f docker-compose.genesis.yml up -d
#
# Requires GITHUB_TOKEN in environment or .env file.

services:
  # Genesis Core — Python autonomous loop engine
  genesis-core:
    build:
      context: ../..
      dockerfile: docker/genesis/Dockerfile.genesis-core
    container_name: genesis-core
    environment:
      - PYTHONUNBUFFERED=1
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GENESIS_REPO_PATH=/app
      - REDIS_URL=redis://genesis-redis:6379/0
      - QDRANT_URL=http://genesis-qdrant:6333
      - OLLAMA_URL=http://genesis-ollama:11434
    volumes:
      - ./../../stacks/genesis:/app/stacks/genesis:ro
      - ./../../genesis_manifest.json:/app/genesis_manifest.json
    depends_on:
      - genesis-redis
      - genesis-qdrant
    networks:
      - genesis-network
    restart: unless-stopped

  # Qdrant — Vector database for agent memory
  genesis-qdrant:
    image: qdrant/qdrant:latest
    container_name: genesis-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - genesis-qdrant-data:/qdrant/storage
    networks:
      - genesis-network
    restart: unless-stopped

  # Ollama — Local LLM inference (optional; comment out if not available)
  genesis-ollama:
    image: ollama/ollama:latest
    container_name: genesis-ollama
    ports:
      - "11434:11434"
    volumes:
      - genesis-ollama-data:/root/.ollama
    networks:
      - genesis-network
    restart: unless-stopped
    profiles:
      - llm  # Only start with: docker-compose --profile llm up

  # Redis — Task queue and caching
  genesis-redis:
    image: redis:7-alpine
    container_name: genesis-redis
    ports:
      - "6380:6379"  # Use 6380 to avoid conflict with existing Redis on 6379
    volumes:
      - genesis-redis-data:/data
    networks:
      - genesis-network
    restart: unless-stopped
    command: redis-server --appendonly yes

networks:
  genesis-network:
    driver: bridge

volumes:
  genesis-qdrant-data:
  genesis-ollama-data:
  genesis-redis-data:
