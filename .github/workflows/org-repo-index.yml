name: Org Repo Index

# Generates .infinity/ORG_REPO_INDEX.json — a live index of every repository
# in the Infinity-X-One-Systems organization.
#
# The job is idempotent: it only commits when the generated index differs from
# the currently committed version.
#
# Authentication: uses the built-in GITHUB_TOKEN.  The token requires
# 'contents: write' (to commit the index) and is automatically scoped to the
# repository.  Organization repository enumeration uses the 'gh repo list'
# command which only requires the default GITHUB_TOKEN permissions when the
# runner is authenticated to the org.

on:
  # Run daily at 02:00 UTC.
  schedule:
    - cron: '0 2 * * *'

  # Allow manual runs with an optional org override.
  workflow_dispatch:
    inputs:
      org_name:
        description: 'GitHub organization to index (default: Infinity-X-One-Systems)'
        required: false
        default: 'Infinity-X-One-Systems'
        type: string

permissions:
  contents: write   # required to commit the generated index

jobs:
  generate-index:
    name: Generate Org Repo Index
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Generate ORG_REPO_INDEX.json
        id: generate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: ${{ inputs.org_name || 'Infinity-X-One-Systems' }}
        run: |
          set -euo pipefail

          echo "Indexing repositories for org: ${ORG_NAME}"

          # Fetch all repositories.
          # Fields: name, description, defaultBranchRef, isPrivate, isArchived,
          #         primaryLanguage, repositoryTopics, createdAt, updatedAt
          # Note: isArchived is the correct field; isDisabled is not supported.
          REPOS=$(gh repo list "${ORG_NAME}" \
            --json name,description,defaultBranchRef,isPrivate,isArchived,primaryLanguage,repositoryTopics,createdAt,updatedAt \
            --limit 1000)

          TOTAL=$(echo "${REPOS}" | jq '. | length')
          ACTIVE=$(echo "${REPOS}" | jq '[.[] | select(.isArchived == false)] | length')
          ARCHIVED=$(echo "${REPOS}" | jq '[.[] | select(.isArchived == true)] | length')
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Found ${TOTAL} repositories (${ACTIVE} active, ${ARCHIVED} archived)"

          # Build the index JSON.
          INDEX=$(jq -n \
            --arg version    "1.0.0" \
            --arg schema_note "Auto-generated by .github/workflows/org-repo-index.yml. Do not edit manually." \
            --arg ts         "${TIMESTAMP}" \
            --arg org        "${ORG_NAME}" \
            --argjson repos  "${REPOS}" \
            --argjson total  "${TOTAL}" \
            --argjson active "${ACTIVE}" \
            --argjson archived "${ARCHIVED}" \
            '{
              version:      $version,
              schema_note:  $schema_note,
              last_updated: $ts,
              organization: $org,
              repositories: [
                $repos[] | {
                  name:           .name,
                  full_name:      ($org + "/" + .name),
                  description:    .description,
                  language:       (.primaryLanguage.name // "unknown"),
                  default_branch: (.defaultBranchRef.name // "main"),
                  private:        .isPrivate,
                  archived:       .isArchived,
                  topics:         [.repositoryTopics[].topic.name],
                  created_at:     .createdAt,
                  updated_at:     .updatedAt
                }
              ],
              statistics: {
                total_repositories:    $total,
                active_repositories:   $active,
                archived_repositories: $archived,
                languages: (
                  $repos
                  | group_by(.primaryLanguage.name // "unknown")
                  | map({ key: (.[0].primaryLanguage.name // "unknown"), value: length })
                  | from_entries
                )
              }
            }')

          # Write the index to the well-known path.
          mkdir -p .infinity
          echo "${INDEX}" | jq '.' > .infinity/ORG_REPO_INDEX.json

          echo "total=${TOTAL}"   >> "${GITHUB_OUTPUT}"
          echo "active=${ACTIVE}" >> "${GITHUB_OUTPUT}"

      - name: Commit and push if changed
        env:
          ORG_NAME: ${{ inputs.org_name || 'Infinity-X-One-Systems' }}
        run: |
          set -euo pipefail

          git config user.name  'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git add .infinity/ORG_REPO_INDEX.json

          if git diff --cached --quiet; then
            echo "No changes to ORG_REPO_INDEX.json — index is already up-to-date."
          else
            git commit -m "chore(index): update ORG_REPO_INDEX.json

          - Organization : ${ORG_NAME}
          - Repositories : ${{ steps.generate.outputs.total }}
          - Active       : ${{ steps.generate.outputs.active }}
          - Timestamp    : $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Trigger      : ${{ github.event_name }}"
            git push
            echo "ORG_REPO_INDEX.json committed and pushed."
          fi

      - name: Write job summary
        if: always()
        run: |
          echo "## Org Repo Index Summary" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Field | Value |" >> "${GITHUB_STEP_SUMMARY}"
          echo "|-------|-------|" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Organization | \`${{ inputs.org_name || 'Infinity-X-One-Systems' }}\` |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Total repositories | ${{ steps.generate.outputs.total || 'n/a' }} |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Active repositories | ${{ steps.generate.outputs.active || 'n/a' }} |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Trigger | \`${{ github.event_name }}\` |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> "${GITHUB_STEP_SUMMARY}"
