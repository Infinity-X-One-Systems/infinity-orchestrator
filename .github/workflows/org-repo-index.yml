name: Org Repo Index

# Periodically refreshes the live index of all repositories in the
# Infinity-X-One-Systems organisation and commits it to .infinity/.
#
# Files updated:
#   .infinity/ORG_REPO_INDEX.json  â€” machine-readable index
#   .infinity/ORG_REPO_INDEX.md    â€” human-readable summary
#
# When the index changes, this workflow optionally dispatches a
# repository_dispatch event (type: repo-index-updated) so that
# downstream workflows (e.g. memory-sync) can react.

on:
  schedule:
    # Refresh every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      dispatch_on_change:
        description: 'Dispatch repo-index-updated event if index changes'
        required: false
        default: 'true'
        type: string

permissions:
  contents: write   # commit updated index files
  issues: write     # create diagnostic issue on failure

jobs:
  refresh-index:
    name: Refresh Org Repo Index
    runs-on: ubuntu-latest

    steps:
      - name: TAP Policy Gate
        run: |
          echo "::notice::TAP Gate â€” actor: github-actions[bot] | action: org-repo-index | trigger: ${{ github.event_name }}"
          echo "::notice::Correlation ID: ${{ github.run_id }}-${{ github.run_attempt }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Discover org repositories
        id: discover
        env:
          # Use GitHub App installation token (P-005) if available; fall back to GITHUB_TOKEN
          # with a warning. The App token must have org:read scope for full org listing.
          GH_TOKEN: ${{ secrets.INFINITY_APP_TOKEN || secrets.GITHUB_TOKEN }}
          ORG_NAME: 'Infinity-X-One-Systems'
          INFINITY_APP_TOKEN_AVAILABLE: ${{ secrets.INFINITY_APP_TOKEN != '' && 'true' || '' }}
        run: |
          set -euo pipefail

          echo "Discovering repositories in org: $ORG_NAME"

          # Diagnose token type (no secret values logged â€” P-001)
          if [ -n "${INFINITY_APP_TOKEN_AVAILABLE:-}" ]; then
            echo "::notice::Using GitHub App installation token for org-wide access (P-005)."
          else
            echo "::warning::INFINITY_APP_TOKEN not set â€” using GITHUB_TOKEN which may have limited org scope."
            echo "::warning::If repo count is 0, ensure the GitHub App is installed org-wide and INFINITY_APP_TOKEN is configured."
          fi

          # Attempt discovery; capture exit code to enable graceful degradation (P-007)
          if ! REPOS=$(gh repo list "$ORG_NAME" \
            --json name,description,defaultBranchRef,isPrivate,isArchived,primaryLanguage,repositoryTopics,createdAt,updatedAt \
            --limit 1000 2>&1); then
            echo "::error::gh repo list failed: $REPOS"
            echo "discover_error=true" >> "$GITHUB_OUTPUT"
            echo "discover_error_message=$REPOS" >> "$GITHUB_OUTPUT"
            # Write a minimal sentinel index so downstream tools don't break (P-007)
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            jq -n \
              --arg ts "$TIMESTAMP" \
              --arg org "$ORG_NAME" \
              --arg err "$REPOS" \
              '{version:"1.0.0",last_updated:$ts,organization:$org,
                generated_by:"org-repo-index.yml",
                note:"Discovery failed â€” see error field for details. Do not use for automation.",
                discovery_error:$err,
                repositories:[],
                statistics:{total:0,active:0,archived:0,languages:{}}}' \
              > .infinity/ORG_REPO_INDEX.json
            exit 1
          fi

          echo "discover_error=false" >> "$GITHUB_OUTPUT"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TOTAL=$(echo "$REPOS" | jq '. | length')
          ACTIVE=$(echo "$REPOS" | jq '[.[] | select(.isArchived == false)] | length')
          ARCHIVED=$(echo "$REPOS" | jq '[.[] | select(.isArchived == true)] | length')
          LANGUAGES=$(echo "$REPOS" | jq \
            'group_by(.primaryLanguage.name // "unknown") |
             map({key: (.[0].primaryLanguage.name // "unknown"), value: length}) |
             from_entries')

          # Warn if result looks unexpectedly empty
          if [ "$TOTAL" -eq 0 ]; then
            echo "::warning::Discovery returned 0 repositories. Check GitHub App permissions and org installation."
          fi

          # Build JSON index
          jq -n \
            --arg version "1.0.0" \
            --arg ts "$TIMESTAMP" \
            --arg org "$ORG_NAME" \
            --argjson repos "$(echo "$REPOS" | jq '[.[] | {
                name: .name,
                full_name: ("'"$ORG_NAME"'/" + .name),
                description: .description,
                language: (.primaryLanguage.name // "unknown"),
                default_branch: (.defaultBranchRef.name // "main"),
                private: .isPrivate,
                archived: .isArchived,
                topics: [.repositoryTopics[].topic.name],
                created_at: .createdAt,
                updated_at: .updatedAt
              }]')" \
            --argjson total "$TOTAL" \
            --argjson active "$ACTIVE" \
            --argjson archived "$ARCHIVED" \
            --argjson langs "$LANGUAGES" \
            '{
              version: $version,
              last_updated: $ts,
              organization: $org,
              generated_by: "org-repo-index.yml",
              note: "Auto-generated by the org-repo-index workflow. Do not edit manually.",
              repositories: $repos,
              statistics: {
                total: $total,
                active: $active,
                archived: $archived,
                languages: $langs
              }
            }' > .infinity/ORG_REPO_INDEX.json

          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "active=$ACTIVE" >> "$GITHUB_OUTPUT"
          echo "archived=$ARCHIVED" >> "$GITHUB_OUTPUT"
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"

          # Build Markdown index
          {
            echo "# Org Repo Index â€” $ORG_NAME"
            echo ""
            echo "> **Auto-generated** by \`.github/workflows/org-repo-index.yml\`."
            echo "> **Do not edit manually.**"
            echo "> Machine-readable data: [\`.infinity/ORG_REPO_INDEX.json\`](./ORG_REPO_INDEX.json)"
            echo ""
            echo "---"
            echo ""
            echo "## Last Updated"
            echo ""
            echo "\`$TIMESTAMP\`"
            echo ""
            echo "---"
            echo ""
            echo "## Summary"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Total repositories | $TOTAL |"
            echo "| Active repositories | $ACTIVE |"
            echo "| Archived repositories | $ARCHIVED |"
            echo ""
            echo "---"
            echo ""
            echo "## Repository List"
            echo ""
            echo "| Name | Language | Default Branch | Private | Archived | Updated |"
            echo "|------|----------|---------------|---------|----------|---------|"
            echo "$REPOS" | jq -r '.[] | "| `\(.name)` | \(.primaryLanguage.name // "unknown") | \(.defaultBranchRef.name // "main") | \(if .isPrivate then "ðŸ”’" else "ðŸŒ" end) | \(if .isArchived then "âœ…" else "â€”" end) | \(.updatedAt[:10]) |"'
            echo ""
            echo "---"
            echo ""
            echo "*Updated automatically every 6 hours by the \`org-repo-index\` workflow.*"
            echo "*To force a refresh, trigger the workflow manually from the Actions tab.*"
          } > .infinity/ORG_REPO_INDEX.md

          echo "Index files generated."

      - name: Commit and push if changed
        id: commit
        run: |
          set -euo pipefail

          git config user.name  'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git add .infinity/ORG_REPO_INDEX.json .infinity/ORG_REPO_INDEX.md

          if git diff --cached --quiet; then
            echo "No changes detected â€” index is already up-to-date."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore(index): refresh org repo index

          - Organisation : Infinity-X-One-Systems
          - Total repos  : ${{ steps.discover.outputs.total }}
          - Active       : ${{ steps.discover.outputs.active }}
          - Archived     : ${{ steps.discover.outputs.archived }}
          - Updated at   : ${{ steps.discover.outputs.timestamp }}
          - Trigger      : ${{ github.event_name }}"

            git push
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Index committed and pushed."
          fi

      - name: Dispatch repo-index-updated event
        if: |
          steps.commit.outputs.changed == 'true' &&
          (github.event_name == 'schedule' || inputs.dispatch_on_change == 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/Infinity-X-One-Systems/infinity-orchestrator/dispatches \
            -f event_type='repo-index-updated' \
            -f "client_payload[total]=${{ steps.discover.outputs.total }}" \
            -f "client_payload[timestamp]=${{ steps.discover.outputs.timestamp }}"
          echo "::notice::Dispatched repo-index-updated event."

      - name: Write job summary
        if: always()
        run: |
          {
            echo "## Org Repo Index Refresh"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Trigger | \`${{ github.event_name }}\` |"
            echo "| Timestamp | \`${{ steps.discover.outputs.timestamp || 'n/a' }}\` |"
            echo "| Total repos | \`${{ steps.discover.outputs.total || 'n/a' }}\` |"
            echo "| Active | \`${{ steps.discover.outputs.active || 'n/a' }}\` |"
            echo "| Archived | \`${{ steps.discover.outputs.archived || 'n/a' }}\` |"
            echo "| Index changed | \`${{ steps.commit.outputs.changed || 'false' }}\` |"
            echo "| Discovery error | \`${{ steps.discover.outputs.discover_error || 'false' }}\` |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create diagnostic issue on discovery failure
        if: failure() && steps.discover.outputs.discover_error == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
          RUN_ID: ${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail

          # Check if a recent open issue already exists to avoid duplicates
          EXISTING=$(gh issue list \
            --repo "Infinity-X-One-Systems/infinity-orchestrator" \
            --label "orchestrator:alert" \
            --state open \
            --search "Org Repo Index discovery failed" \
            --json number --jq '.[0].number' 2>/dev/null || echo "")

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ -n "$EXISTING" ]; then
            echo "Diagnostic issue #$EXISTING already open â€” adding comment."
            gh issue comment "$EXISTING" \
              --repo "Infinity-X-One-Systems/infinity-orchestrator" \
              --body "ðŸ” **Recurring failure** on [run ${RUN_ID}](${RUN_URL}) at ${TIMESTAMP}. See workflow logs for details."
          else
            # Write issue body to a temp file to avoid YAML/shell quoting issues
            BODY_FILE=$(mktemp)
            {
              printf '## Org Repo Index Discovery Failure\n\n'
              printf 'The `org-repo-index` workflow failed to list repositories for the `Infinity-X-One-Systems` org.\n\n'
              printf '**Run:** [Run %s](%s)\n' "$RUN_ID" "$RUN_URL"
              printf '**Trigger:** `%s`\n' "$EVENT_NAME"
              printf '**Timestamp:** `%s`\n\n' "$TIMESTAMP"
              printf '## Likely Causes\n\n'
              printf '1. **INFINITY_APP_TOKEN not set** â€” Add a GitHub App installation token secret named `INFINITY_APP_TOKEN` with `org:read` scope.\n'
              printf '2. **GITHUB_TOKEN scope** â€” The default token may not have org-wide read access. Use a GitHub App installation token (P-005).\n'
              printf '3. **App not installed org-wide** â€” Ensure the `infinity-orchestrator-app` GitHub App is installed on all org repositories.\n\n'
              printf '## Resolution\n\n'
              printf '- Set `INFINITY_APP_TOKEN` secret with a valid GitHub App installation token.\n'
              printf '- Verify the token has **Read access to members** and **Read access to metadata**.\n'
              printf '- Re-run this workflow after fixing permissions.\n\n'
              printf '---\n*Auto-created by org-repo-index workflow â€” TAP P-001 compliant (no secrets in body)*\n'
            } > "$BODY_FILE"
            gh issue create \
              --repo "Infinity-X-One-Systems/infinity-orchestrator" \
              --title "ðŸš¨ Org Repo Index discovery failed â€” check GitHub App permissions" \
              --label "orchestrator:alert,priority:high" \
              --body-file "$BODY_FILE"
            rm -f "$BODY_FILE"
          fi
