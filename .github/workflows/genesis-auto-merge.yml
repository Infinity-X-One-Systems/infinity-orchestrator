name: Genesis Auto-Merge Autonomous PRs

on:
  pull_request:
    types: [labeled, synchronize]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: ü§ñ Auto-Merge Verified PRs
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'autonomous-verified')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PR Status
        id: pr-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const hasLabel = pr.labels.some(label => label.name === 'autonomous-verified');
            if (!hasLabel) {
              console.log('PR does not have autonomous-verified label');
              core.setOutput('result', 'false');
              return;
            }

            if (!pr.mergeable) {
              console.log('PR is not mergeable (conflicts)');
              core.setOutput('result', 'false');
              return;
            }

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const failedChecks = checkRuns.check_runs.filter(
              check => check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );

            if (failedChecks.length > 0) {
              console.log('Some checks failed:', failedChecks.map(c => c.name));
              core.setOutput('result', 'false');
              return;
            }

            console.log('All checks passed, PR is ready to merge');
            core.setOutput('result', 'true');

      - name: Wait for CI to Complete
        if: steps.pr-status.outputs.result == 'true'
        run: |
          echo "Waiting for CI to complete..."
          sleep 30

      - name: Enable Auto-Merge
        if: steps.pr-status.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: `ü§ñ Auto-merge: ${context.payload.pull_request.title}`,
                commit_message: 'Automatically merged by Genesis autonomous system after validation.'
              });

              console.log('‚úÖ PR merged successfully');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ü§ñ **Genesis Autonomous Merge Complete**\n\nThis PR has been automatically merged after passing all validation checks.\n\n‚úÖ All CI checks passed\n‚úÖ Code review approved\n‚úÖ Autonomous verification complete'
              });

            } catch (error) {
              console.error('Failed to merge PR:', error);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è **Auto-merge failed**\n\nError: ${error.message}\n\nPlease merge manually or investigate the issue.`
              });

              throw error;
            }

  notify-status:
    name: üì¢ Notify Merge Status
    runs-on: ubuntu-latest
    needs: [auto-merge]
    if: always()

    steps:
      - name: Report Status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.auto-merge.result }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            console.log(`${emoji} Genesis auto-merge job ${status}`);
