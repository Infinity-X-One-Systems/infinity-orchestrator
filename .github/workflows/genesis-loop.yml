name: Genesis Autonomous Loop

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      phase:
        description: 'Phase to execute'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - plan
          - code
          - validate
          - diagnose
          - heal
          - deploy

permissions:
  contents: write
  pull-requests: write
  issues: write

# Expose stacks/ as the Python package root so `import genesis.core.xxx` works
env:
  PYTHONPATH: ${{ github.workspace }}/stacks

jobs:
  plan:
    name: ðŸ§  Plan Phase
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'plan'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Execute Plan Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py plan

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-plan
          path: genesis_manifest.json
          retention-days: 7

  code:
    name: ðŸ’» Code Phase
    runs-on: ubuntu-latest
    needs: [plan]
    if: github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'code'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Download plan artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-plan
        continue-on-error: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Execute Code Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py code

      - name: Upload code artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesis-code
          path: |
            genesis_manifest.json
            logs/
          retention-days: 7

  validate:
    name: âœ… Validate Phase
    runs-on: ubuntu-latest
    needs: [code]
    if: github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'validate'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Download code artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-code
        continue-on-error: true

      - name: Run Python Tests
        run: python -m pytest tests/ -v --cov=stacks/genesis --cov-report=term-missing
        continue-on-error: true

      - name: Run Linters
        run: |
          python -m pylint stacks/genesis --exit-zero
          python -m black --check stacks/genesis/
        continue-on-error: true

      - name: Execute Validate Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py validate

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: genesis-validation
          path: |
            genesis_manifest.json
            .coverage
          retention-days: 7

  diagnose:
    name: ðŸ” Diagnose Phase
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'diagnose')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Download validation artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-validation
        continue-on-error: true

      - name: Execute Diagnose Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py diagnose

      - name: Upload diagnostic results
        uses: actions/upload-artifact@v4
        with:
          name: genesis-diagnostics
          path: |
            genesis_manifest.json
            logs/
          retention-days: 7

  heal:
    name: ðŸ”§ Heal Phase
    runs-on: ubuntu-latest
    needs: [diagnose]
    if: always() && (github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'heal')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Download diagnostic artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-diagnostics
        continue-on-error: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Execute Heal Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py heal

      - name: Upload healing results
        uses: actions/upload-artifact@v4
        with:
          name: genesis-healing
          path: |
            genesis_manifest.json
            logs/
          retention-days: 7

  deploy:
    name: ðŸš€ Deploy Phase
    runs-on: ubuntu-latest
    needs: [heal]
    if: github.event_name == 'schedule' || github.event.inputs.phase == 'full' || github.event.inputs.phase == 'deploy'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.genesis.txt

      - name: Download healing artifacts
        uses: actions/download-artifact@v4
        with:
          name: genesis-healing
        continue-on-error: true

      - name: Execute Deploy Phase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENESIS_REPO_PATH: ${{ github.workspace }}
        run: python stacks/genesis/core/loop.py deploy

      - name: Update System Manifest
        uses: actions/upload-artifact@v4
        with:
          name: genesis-manifest-final
          path: genesis_manifest.json
          retention-days: 30

  summary:
    name: ðŸ“Š Generate Summary
    runs-on: ubuntu-latest
    needs: [plan, code, validate, diagnose, heal, deploy]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate Execution Summary
        run: |
          echo "# ðŸŒŸ Genesis Autonomous Loop Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§  Plan: ${{ needs.plan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’» Code: ${{ needs.code.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validate: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Diagnose: ${{ needs.diagnose.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Heal: ${{ needs.heal.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## System Manifest" >> $GITHUB_STEP_SUMMARY
          if [ -f "genesis-manifest-final/genesis_manifest.json" ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat genesis-manifest-final/genesis_manifest.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Manifest not available" >> $GITHUB_STEP_SUMMARY
          fi
